<!DOCTYPE html>
<html>
    <head>
        <center><h1 id="text">Canvas</h1></center>
        <meta charset="utf-8"/>
    </head>
    <body>
        <center><canvas id="canvas" width="500" height="500" style="border:3px solid black;"></canvas></center>
        <script>

            var ctx, canvas;
            var edgeLength = 500;
            var dragEnabled = false;
            var rotate = 0;
                                    //  x    y  rad  srad  tn   col
            var bigGear = new Gear    (150, 180, 130, 145, 50, 'orange');
            var smallGear = new Gear  (327.6, 280, 55, 70, 18, 'blue');
            var triggerGear = new Gear(250, 400, 23, 36, 7, 'red');

            function init() {

                canvas = document.getElementById("canvas");
                ctx = canvas.getContext("2d");
                return setInterval(drawGears, 25);
            }


            function drawGears(){

                rotAngle = Math.PI/180/4;
                ctx.clearRect(0, 0, edgeLength, edgeLength);
                smallGear.enableRotation(rotate, rotAngle*(bigGear.teethNumber/smallGear.teethNumber));
                bigGear.enableRotation(rotate*(-1), rotAngle);
                triggerGear.enableRotation(1, rotAngle*(bigGear.teethNumber/smallGear.teethNumber)/0.38875);

                if (Math.sqrt(Math.pow(bigGear.xPos - triggerGear.xPos, 2) + Math.pow(bigGear.yPos - triggerGear.yPos, 2)) <= triggerGear.teethRadius+7.2+bigGear.radius) {
                    rotate = 1;
                    dragEnabled = false;
                }

                else if (Math.sqrt(Math.pow(smallGear.xPos - triggerGear.xPos, 2) + Math.pow(smallGear.yPos - triggerGear.yPos, 2)) <= triggerGear.teethRadius+4+smallGear.radius) {
                    rotate = -1;
                    dragEnabled = false;
                }

                else
                    rotate = 0;
            }

            function Gear(xPos, yPos, radius, teethRadius, teethNumber, color) {

                var rotationAngle = 0;

                this.xPos = xPos;
                this.yPos = yPos;
                this.radius = radius;
                this.teethNumber = teethNumber;
                this.teethRadius = teethRadius;
                this.color = color;
                this.drawGear = function drawGear() {

                    var rSmall, rBig; // Skritulio ir dantens ka
                    var x, y, spikeX, spikeY;
                    var incSmall = 360/this.teethNumber; // dantu inkrementai
                    var incBig = 360/this.teethNumber/2;

                    // Dantiracio skritulys
                    ctx.beginPath();
                    ctx.fillStyle = this.color;
                    ctx.arc(0, 0, this.radius, 0, Math.PI*2, true);
                    ctx.fill();

                    // Dantiracio vidurys
                    ctx.beginPath();
                    ctx.fillStyle = 'white';
                    ctx.arc(0, 0, 10, 0, Math.PI * 2, true);
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = this.color;
                    rSmall = rBig = 0;

                    // Dantu generavimas
                    for (i = 0; i < this.teethNumber; i++, rSmall+=incSmall) {

                        // Randamos trikampio kampo koordinates
                        x = this.radius*Math.cos(Math.PI*rSmall/180);
                        y = this.radius*Math.sin(Math.PI*rSmall/180);

                        // Randamos trikampio virsunes korrdinates
                        spikeX = this.teethRadius*Math.cos(Math.PI*(rSmall+incBig)/180);
                        spikeY = this.teethRadius*Math.sin(Math.PI*(rSmall+incBig)/180);

                        // Piesiamas trikampis
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(spikeX, spikeY);
                        ctx.lineTo(this.radius*Math.cos(Math.PI*(rSmall+incSmall)/180), this.radius*Math.sin(Math.PI*(rSmall+incSmall)/180));
                        ctx.fill();
                        ctx.stroke();
                    }
                }
                this.enableRotation = function enableRotation(direction, angleIncrement) {

                    rotationAngle += angleIncrement;

                    // Direction 0 - stovi vietoje, 1 - sukasi pagal laikrodzio rodykle, -1 - sukasi pries laikrodzio rodykle
                    if (direction == 0) {
                        ctx.save();
                        ctx.translate(this.xPos, this.yPos);
                        this.drawGear();
                        ctx.restore();
                        rotationAngle = 0;
                    }

                    if (direction == 1) {
                        ctx.save();
                        ctx.translate(this.xPos, this.yPos);
                        ctx.rotate(rotationAngle);
                        this.drawGear();
                        ctx.restore();
                    }

                    if (direction == -1) {
                        ctx.save();
                        ctx.translate(this.xPos, this.yPos);
                        ctx.rotate(-rotationAngle);
                        this.drawGear();
                        ctx.restore();
                    }

                    if( rotationAngle >= (Math.PI*2))
                        rotationAngle = 0;
                }
            }

            function mouseDrag(e) {

                if (dragEnabled) {
                    triggerGear.xPos = e.pageX - canvas.offsetLeft;
                    triggerGear.yPos = e.pageY - canvas.offsetTop;
                }
            }

            function mouseDown(e) {

                    x = triggerGear.xPos;
                    y = triggerGear.yPos;
                    if (e.pageX < x + 20 + canvas.offsetLeft  && e.pageX > x -20 + canvas.offsetLeft &&
                        e.pageY < y + 20 + canvas.offsetTop   && e.pageY > y -20 + canvas.offsetTop )
                    {
                        triggerGear.xPos = e.pageX - canvas.offsetLeft;
                        triggerGear.yPos = e.pageY - canvas.offsetTop;
                        dragEnabled = true;
                        canvas.onmousemove = mouseDrag;
                    }
            }

            function mouseUp() {

                dragEnabled = false;
                canvas.onmousemove = null;
            }

            init();
            canvas.onmousedown = mouseDown;
            canvas.onmouseup = mouseUp;

        </script>
    </body>
</html>
